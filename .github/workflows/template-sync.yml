name: Template Sync Verification
on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened, edited]
    paths:
      - "packages/cli/templates/typescript/**"
      - "examples/*/**"

jobs:
  verify-template-sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v46
        with:
          files: |
            packages/cli/templates/typescript/**
            examples/**

      - name: Check PR description
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        id: pr
        run: |
          echo "skip=$([[ "$PR_BODY" == *"skip-test-verification"* ]] && echo "true" || echo "false")" >> $GITHUB_OUTPUT

      - name: Verify template sync
        if: steps.pr.outputs.skip != 'true'
        run: |
          status=0
          template_changes=()
          example_changes=()

          # Create associative arrays to track directories and their files
          declare -A template_dirs example_dirs

          # Group files by directory
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            if [[ $file == packages/cli/templates/typescript/* ]]; then
              dir=$(echo "$file" | sed -n 's|packages/cli/templates/typescript/\([^/]*\)/.*|\1|p')
              if [ ! -z "$dir" ]; then
                # Append the file to the directory's list
                template_dirs["$dir"]="${template_dirs["$dir"]}${file}"$'\n'
              fi
            elif [[ $file == examples/* ]]; then
              dir=$(echo "$file" | sed -n 's|examples/\([^/]*\)/.*|\1|p')
              if [ ! -z "$dir" ]; then
                # Append the file to the directory's list
                example_dirs["$dir"]="${example_dirs["$dir"]}${file}"$'\n'
              fi
            fi
          done

          # Check template directories without matching example changes
          for dir in "${!template_dirs[@]}"; do
            # Only check if the corresponding example directory exists
            if [[ -d "examples/$dir" && -z "${example_dirs[$dir]}" ]]; then
              echo "::error::Changes detected in template directory but no corresponding example changes found (use skip-test-verification in PR description to skip this check)"
              echo "Template directory: packages/cli/templates/typescript/$dir"
              echo "Changed files:"
              echo "${template_dirs[$dir]}"
              echo "Expected changes in: examples/$dir"
              status=1
            fi
          done

          # Check example directories without matching template changes
          for dir in "${!example_dirs[@]}"; do
            # Only check if the corresponding template directory exists
            if [[ -d "packages/cli/templates/typescript/$dir" && -z "${template_dirs[$dir]}" ]]; then
              echo "::error::Changes detected in example directory but no corresponding template changes found (use skip-test-verification in PR description to skip this check)"
              echo "Example directory: examples/$dir"
              echo "Changed files:"
              echo "${example_dirs[$dir]}"
              echo "Expected changes in: packages/cli/templates/typescript/$dir"
              status=1
            fi
          done

          exit $status
